// ====================================================================================
// Google Apps Script - Backend para Gerenciador de Cursos
// ====================================================================================
// üö® SOLU√á√ÉO DE PROBLEMAS (TROUBLESHOOTING) üö®
//
// ERRO: "N√£o foi poss√≠vel identificar o usu√°rio. (...)"
//
// Se voc√™ est√° vendo este erro, a causa em 99% dos casos √© a configura√ß√£o "Executar como".
// Para que `Session.getActiveUser().getEmail()` funcione, o script PRECISA ser executado
// com a sua identidade (a do dono da planilha).
//
// SOLU√á√ÉO: V√° em "Implantar" > "Gerenciar Implanta√ß√µes", edite (‚úé) sua implanta√ß√£o e
// GARANTA que a configura√ß√£o "Executar como" esteja definida como "Eu (seu-email@exemplo.com)".
// A outra configura√ß√£o, "Quem pode acessar", deve ser "Qualquer pessoa".
// AMBAS precisam estar corretas. Ap√≥s corrigir, crie uma NOVA VERS√ÉO.
//
// ====================================================================================
// INSTRU√á√ïES DE IMPLANTA√á√ÉO:
// 1. Abra o Google Drive e crie uma nova Planilha (Google Sheet).
// 2. Renomeie a planilha para "CursosDB".
// 3. Na primeira linha (cabe√ßalho), adicione as seguintes colunas, EXATAMENTE nesta ordem:
//    id | description | isSecurity | isUdemy | userEmail | createdAt
// 4. No menu da planilha, v√° em "Extens√µes" > "Apps Script".
// 5. Apague todo o c√≥digo que estiver no editor e cole este c√≥digo. Salve o projeto (d√™ um nome, ex: "API Cursos").
// 6. Clique em "Implantar" > "Nova implanta√ß√£o".
// 7. Na janela que abrir:
//    - Clique no √≠cone de engrenagem ao lado de "Selecione o tipo" e escolha "App da Web".
//    - D√™ uma descri√ß√£o (opcional, ex: "API para CRUD de cursos").
//    - üö® CONFIGURA√á√ÉO CR√çTICA #1: Em "Executar como", selecione "Eu (seu-email@gmail.com)".
//        -> ESSENCIAL para o script identificar seu e-mail. Causa o erro de "usu√°rio n√£o identificado".
//    - üö® CONFIGURA√á√ÉO CR√çTICA #2: Em "Quem pode acessar", selecione "Qualquer pessoa".
//        -> ESSENCIAL para permitir que sua aplica√ß√£o web chame a API. Causa o erro "Failed to fetch".
// 8. Clique em "Implantar".
// 9. O Google pedir√° autoriza√ß√£o. Siga os passos para autorizar o script. Pode ser necess√°rio clicar em "Avan√ßado" e "Acessar projeto..." (n√£o seguro).
// 10. Ap√≥s a implanta√ß√£o, uma URL do app da Web ser√° exibida. COPIE essa URL.
// 11. Cole a URL copiada na constante `SCRIPT_URL` no arquivo `src/services/sheetService.ts` do seu projeto React.
// ====================================================================================
// **LEMBRE-SE:** Sempre que voc√™ alterar este script, voc√™ DEVE criar uma "Nova vers√£o" em "Gerenciar implanta√ß√µes" para que as altera√ß√µes entrem em vigor.
// ====================================================================================


/**
 * Fun√ß√£o auxiliar para obter a planilha de forma segura.
 * Lan√ßa um erro se a planilha n√£o for encontrada.
 * @returns {Sheet} O objeto da planilha.
 */
function getSheet() {
  const SHEET_NAME = 'CursosDB';
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) {
    throw new Error(`A planilha com o nome "${SHEET_NAME}" n√£o foi encontrada. Verifique se a aba na sua planilha tem exatamente este nome.`);
  }
  return sheet;
}

/**
 * Lida com as requisi√ß√µes GET. Roteia para a a√ß√£o apropriada.
 */
function doGet(e) {
  try {
    const action = e.parameter.action;
    if (action === 'read') {
      return handleRead();
    }
    throw new Error('A√ß√£o GET inv√°lida ou n√£o especificada.');
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Lida com as requisi√ß√µes POST. Roteia para a a√ß√£o apropriada.
 */
function doPost(e) {
  try {
    const requestData = JSON.parse(e.postData.contents);
    const action = requestData.action;

    switch (action) {
      case 'create':
        return handleCreate(requestData.data);
      case 'update':
        return handleUpdate(requestData.id, requestData.data);
      case 'delete':
        return handleDelete(requestData.id);
      default:
        throw new Error('A√ß√£o POST inv√°lida ou n√£o especificada.');
    }
  } catch (error) {
    // Log do erro para depura√ß√£o no Apps Script
    console.error(`Erro em doPost: ${error.toString()} Stack: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * L√™ todos os registros da planilha.
 */
function handleRead() {
  const sheet = getSheet();
  const data = sheet.getDataRange().getValues();
  const headers = data.shift(); // Remove o cabe√ßalho
  
  const result = data.map(row => {
    let course = {};
    headers.forEach((header, index) => {
      if (header === 'isSecurity' || header === 'isUdemy') {
        course[header] = row[index] === true || String(row[index]).toLowerCase() === 'true';
      } else {
        course[header] = row[index];
      }
    });
    return course;
  }).filter(row => row.id); // Garante que n√£o estamos retornando linhas vazias
  
  return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: result }))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Cria um novo registro na planilha.
 */
function handleCreate(data) {
  const sheet = getSheet();
  const user = Session.getActiveUser();
  const userEmail = user ? user.getEmail() : null;
  
  // Esta verifica√ß√£o √© crucial. Se a implanta√ß√£o n√£o estiver configurada corretamente
  // ("Executar como: Eu"), getEmail() falhar√°.
  if (!userEmail) {
    throw new Error('N√£o foi poss√≠vel identificar o usu√°rio. Certifique-se de que est√° logado em uma conta Google e que concedeu as permiss√µes necess√°rias. Verifique se a implanta√ß√£o do App da Web est√° configurada para ser executada como voc√™ e o acesso √© para "Qualquer pessoa".');
  }

  const newId = Utilities.getUuid();
  const creationDate = new Date().toISOString();
  
  const newRow = [
    newId,
    data.description,
    data.isSecurity,
    data.isUdemy,
    userEmail.trim(),
    creationDate
  ];
  sheet.appendRow(newRow);
  
  const newCourse = { 
    id: newId, 
    description: data.description,
    isSecurity: data.isSecurity,
    isUdemy: data.isUdemy,
    userEmail: userEmail.trim(),
    createdAt: creationDate 
  };

  return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: newCourse }))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Encontra o n√∫mero da linha com base em um ID.
 * @param {string} id - O ID do curso a ser encontrado.
 * @returns {number} O n√∫mero da linha (baseado em 1) ou -1 se n√£o for encontrado.
 */
function findRowById(id) {
    const sheet = getSheet();
    // getValues() pode ser lento em planilhas grandes, mas √© suficiente para este caso.
    const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues().flat();
    const rowIndex = ids.indexOf(id);
    return rowIndex === -1 ? -1 : rowIndex + 2; // +2 porque o √≠ndice √© 0-based e a planilha √© 1-based com cabe√ßalho
}

/**
 * Atualiza um registro existente.
 */
function handleUpdate(id, data) {
  const sheet = getSheet();
  const rowNum = findRowById(id);
  if (rowNum === -1) {
    throw new Error('Curso n√£o encontrado para atualiza√ß√£o.');
  }

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const descriptionCol = headers.indexOf('description') + 1;
  const isSecurityCol = headers.indexOf('isSecurity') + 1;
  const isUdemyCol = headers.indexOf('isUdemy') + 1;

  // Valida se as colunas foram encontradas
  if(!descriptionCol || !isSecurityCol || !isUdemyCol) {
    throw new Error("Uma ou mais colunas de cabe√ßalho necess√°rias (description, isSecurity, isUdemy) n√£o foram encontradas.");
  }

  sheet.getRange(rowNum, descriptionCol).setValue(data.description);
  sheet.getRange(rowNum, isSecurityCol).setValue(data.isSecurity);
  sheet.getRange(rowNum, isUdemyCol).setValue(data.isUdemy);

  const updatedRowData = sheet.getRange(rowNum, 1, 1, sheet.getLastColumn()).getValues()[0];
  let updatedCourse = {};
   headers.forEach((header, index) => {
      if (header === 'isSecurity' || header === 'isUdemy') {
        updatedCourse[header] = updatedRowData[index] === true || String(updatedRowData[index]).toLowerCase() === 'true';
      } else {
        updatedCourse[header] = updatedRowData[index];
      }
    });
  
  return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: updatedCourse }))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Exclui um registro.
 */
function handleDelete(id) {
    const sheet = getSheet();
    const rowNum = findRowById(id);
    if (rowNum === -1) {
        throw new Error('Curso n√£o encontrado para exclus√£o.');
    }
    sheet.deleteRow(rowNum);
    return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'Curso deletado' }))
        .setMimeType(ContentService.MimeType.JSON);
}
